<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>MIND - Projetos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="javascript/components/menu.js" defer></script>
  <script src="javascript/components/footer.js" defer></script>
  <style>
    #page-wrapper {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 100vh;
      max-width: 100%;
      margin: auto;
      overflow: auto;
    }

    /* === Gr√°fico centralizado e compacto === */
    .grafico-container {
      position: relative;
      height: 250px;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
    }
    #graficoProjetos {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <meu-menu></meu-menu>
  <div id="page-wrapper">
    <main class="container-fluid d-flex flex-column my-0 pt-0 mt-1 mb-5">
      <section class="mt-2">
        <h2 class="text-center text-danger">
          <strong>Movimento para Inclus√£o e Neurodiversidade.</strong>
        </h2>

        <div class="container text-center">
          <h5 class="text-black"><strong>Projetos desenvolvidos pela equipe MIND.</strong></h5>
          <h6>Gr√°fico: Projetos por Categoria e Ano</h6>
          <div class="grafico-container">
            <canvas id="graficoProjetos"></canvas>
          </div>
        </div>

        <!-- === Filtros === -->
        <div class="row g-2 my-4">
          <div class="col-md-3">
            <input type="text" id="pesquisaInput" class="form-control" placeholder="Buscar por nome...">
          </div>
          <div class="col-md-2">
            <select id="filtroAutores" class="form-select"><option value="">Filtrar por Autores</option></select>
          </div>
          <div class="col-md-2">
            <select id="filtroTipos" class="form-select"><option value="">Filtrar por Tipo</option></select>
          </div>
          <div class="col-md-2">
            <select id="filtroCategorias" class="form-select"><option value="">Filtrar por Categoria</option></select>
          </div>
          <div class="col-md-2">
            <select id="filtroAnos" class="form-select"><option value="">Filtrar por Ano</option></select>
          </div>
          <div class="col-md-1">
            <button id="btnLimpar" class="btn btn-secondary w-100">Limpar</button>
          </div>
        </div>

        <!-- === Tabela === -->
        <div class="table-responsive">
          <table id="tabelaProjetos" class="table table-striped table-bordered w-100">
            <thead class="table-dark text-center">
              <tr>
                <th>ID</th>
                <th>Nome do Jogo</th>
                <th>T√≠tulo da Publica√ß√£o</th>
                <th>Autor Desenvolvedor</th>
                <th>Tipo</th>
                <th>Categoria</th>
                <th>Ano</th>
                <th>Publica√ß√£o</th>
                <th>Projeto</th>
              </tr>
            </thead>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- === Modal === -->
  <div class="modal fade" id="modalProjetos" tabindex="-1" aria-labelledby="modalProjetosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalProjetosLabel">Visualizar Projeto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <iframe id="iframeProjetos" src="" width="100%" height="600" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- === Scripts === -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="javascript/dados-projetos.js"></script>

  <script>
    let chartInstance;
    let tabelaDT;

    document.addEventListener('DOMContentLoaded', () => {
      const itens = listarItens('projetos');
      const selAutores = $('#filtroAutores');
      const selTipos = $('#filtroTipos');
      const selCategorias = $('#filtroCategorias');
      const selAnos = $('#filtroAnos');

      // === Popula filtros ===
      function popularFiltros() {
        const autores = [...new Set(itens.map(i => i.autor))].sort();
        const tipos = [...new Set(itens.map(i => i.tipo))].sort();
        const categorias = [...new Set(itens.map(i => i.categoria))].sort();
        const anos = [...new Set(itens.map(i => i.ano))].sort();

        autores.forEach(v => selAutores.append(new Option(v, v)));
        tipos.forEach(v => selTipos.append(new Option(v, v)));
        categorias.forEach(v => selCategorias.append(new Option(v, v)));
        anos.forEach(v => selAnos.append(new Option(v, v)));
      }

      // === Filtros aplicados ===
      function aplicarFiltros() {
        const q = $('#pesquisaInput').val().toLowerCase();
        const a = selAutores.val();
        const t = selTipos.val();
        const c = selCategorias.val();
        const y = selAnos.val();

        return itens.filter(i =>
          (!a || i.autor === a) &&
          (!t || i.tipo === t) &&
          (!c || i.categoria === c) &&
          (!y || i.ano === y) &&
          (!q || i.nomeProducao.toLowerCase().includes(q))
        );
      }

      // === Renderiza tabela ===
      function renderizarTabela(data) {
        if (tabelaDT) {
          tabelaDT.clear().rows.add(data).draw();
        } else {
          tabelaDT = $('#tabelaProjetos').DataTable({
            data: data,
            columns: [
              { data: 'id' },
              { data: 'nomeProducao' },
              { data: 'titulo' },
              { data: 'autor', render: d => `<strong>${d}</strong>` },
              { data: 'tipo' },
              { data: 'categoria', render: d => `<strong>${d}</strong>` },
              { data: 'ano' },
              {
                data: null,
                render: d => `
                  <div class="mb-2">
                    <a href="${d.linkPublicacao}" class="btn btn-warning btn-sm w-100" target="_blank">üåê Publica√ß√£o</a>
                  </div>
                  <div>
                    ${d.publicacaoArquivo
                      ? `<a href="${d.publicacaoArquivo}" class="btn btn-success btn-sm w-100" target="_blank">üìñ PDF</a>`
                      : `<button class="btn btn-secondary btn-sm w-100" disabled>‚ùå Sem PDF</button>`
                    }
                  </div>`
              },
              {
                data: 'id',
                render: id => `<button class="btn btn-primary btn-sm" onclick="abrirJanela('${id}')">üîó Acessar</button>`
              }
            ],
            paging: true,
            responsive: true,
            language: {
              info: "Mostrando _START_ at√© _END_ de _TOTAL_ registros",
              infoEmpty: "Mostrando 0 at√© 0 de 0 registros",
              lengthMenu: "Mostrar _MENU_ registros por p√°gina",
              search: "Pesquisar:",
              paginate: {
                first: "Primeiro",
                last: "√öltimo",
                next: "Pr√≥ximo",
                previous: "Anterior"
              }
            }
          });
        }
      }

      // === Renderiza gr√°fico (compacto e proporcional) ===
      function renderizarGrafico(data) {
        const group = {};
        data.forEach(i => {
          if (!group[i.categoria]) group[i.categoria] = {};
          if (!group[i.categoria][i.ano]) group[i.categoria][i.ano] = 0;
          group[i.categoria][i.ano]++;
        });

        const categoriasArr = Object.keys(group);
        const anosArr = [...new Set(data.map(i => i.ano))].sort();
        const colors = ['#007bff','#28a745','#ffc107','#dc3545','#17a2b8'];
        const datasets = categoriasArr.map((cat, idx) => ({
          label: cat,
          backgroundColor: colors[idx % colors.length],
          data: anosArr.map(y => group[cat][y] || 0)
        }));

        function calcularMaximo(datasets) {
          let max = 0;
          datasets.forEach(ds => {
            const dsMax = Math.max(...ds.data);
            if (dsMax > max) max = dsMax;
          });
          return Math.ceil(max + 1);
        }

        const ctx = document.getElementById('graficoProjetos').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: { labels: anosArr, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            barPercentage: 0.6,
            categoryPercentage: 0.8,
            layout: { padding: 10 },
            plugins: {
              legend: { position: 'bottom' },
              datalabels: { anchor: 'end', align: 'end', formatter: Math.round }
            },
            scales: {
              x: {
                ticks: { autoSkip: false, maxRotation: 45 },
                grid: { display: false }
              },
              y: {
                beginAtZero: true,
                suggestedMax: calcularMaximo(datasets),
                ticks: {
                  stepSize: 1,
                  precision: 0,
                  callback: v => Number.isInteger(v) ? v : null
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });
      }

      function atualizar() {
        const filtrado = aplicarFiltros();
        renderizarTabela(filtrado);
        renderizarGrafico(filtrado);
      }

      $('#pesquisaInput, #filtroAutores, #filtroTipos, #filtroCategorias, #filtroAnos').on('input change', atualizar);
      $('#btnLimpar').on('click', () => {
        $('#pesquisaInput').val('');
        selAutores.val('');
        selTipos.val('');
        selCategorias.val('');
        selAnos.val('');
        atualizar();
      });

      popularFiltros();
      atualizar();
    });

    // === Abre projeto em nova janela ===
    function abrirJanela(id) {
      const url = `modal.html?id=${id}`;
      window.open(url, '_blank', `width=1200,height=800,scrollbars=yes,resizable=yes`);
    }
  </script>

  <meu-footer></meu-footer>
</body>
</html>
