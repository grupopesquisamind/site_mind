<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>MIND - Publica√ß√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/style.css" />
  <script src="javascript/components/menu.js" defer></script>
  <script src="javascript/components/footer.js" defer></script>
  <script src="javascript/components/components.js" defer></script>

  <style>
    #page-wrapper {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 100vh;
      max-width: 100%;
      margin: auto;
      overflow: auto;
    }

    /* Justifica√ß√£o de texto no modal */
    #conteudoReferencia p {
      text-align: justify;
    }

    /* Ajustes visuais e responsivos dos bot√µes */
    .btn-group-custom {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }

    .btn-group-custom .btn {
      flex: 1 1 calc(50% - 6px);
      min-width: 130px;
    }

    @media (max-width: 576px) {
      .btn-group-custom .btn {
        flex: 1 1 100%;
      }
    }
  </style>
</head>

<body class="py-5">
  <meu-menu></meu-menu>

  <div id="page-wrapper">
    <main class="container-fluid d-flex flex-column my-0 pt-0 mt-1 mb-5">
      <section class="mt-2">
        <h2 class="text-center text-danger"><strong>Movimento para Inclus√£o e Neurodiversidade.</strong></h2>

        <!-- Gr√°fico -->
        <div class="container text-center">
          <h5 class="text-black"><strong>Publica√ß√µes realizadas pela equipe MIND.</strong></h5>
          <h6>Gr√°fico: Publica√ß√µes por Tipo e Ano</h6>
          <div style="position:relative; height:250px; width:100%; max-width:900px; margin:auto;">
            <canvas id="graficoPublicacoes"></canvas>
          </div>
        </div>

        <!-- Filtros -->
        <div class="row g-2 my-4 justify-content-center">
          <div class="col-md-3"><input type="text" id="pesquisaInput" class="form-control" placeholder="Buscar por t√≠tulo..."></div>
          <div class="col-md-2"><select id="filtroAutores" class="form-select"><option value="">Filtrar por Autor</option></select></div>
          <div class="col-md-2"><select id="filtroTipos" class="form-select"><option value="">Filtrar por Tipo</option></select></div>
          <div class="col-md-2"><select id="filtroSiglas" class="form-select"><option value="">Filtrar por Sigla</option></select></div>
          <div class="col-md-2"><select id="filtroAnos" class="form-select"><option value="">Filtrar por Ano</option></select></div>
          <div class="col-md-1"><button id="btnLimpar" class="btn btn-secondary w-100">Limpar</button></div>
        </div>

        <!-- Tabela -->
        <div class="table-responsive">
          <table id="tabelaPublicacoes" class="table table-striped table-bordered w-100">
            <thead class="table-dark text-center">
              <tr>
                <th>ID</th>
                <th>T√≠tulo</th>
                <th>Autor</th>
                <th>Co-Autor(es)</th>
                <th>Tipo</th>
                <th>Local</th>
                <th>Sigla</th>
                <th>Ano</th>
                <th>Publica√ß√£o</th>
                <th>Trabalho</th>
              </tr>
            </thead>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal de Refer√™ncia -->
  <div class="modal fade" id="modalReferencia" tabindex="-1" aria-labelledby="modalReferenciaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalReferenciaLabel">Dados da Publica√ß√£o</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="conteudoReferencia"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="javascript/dados-publicacoes.js"></script>

  <script>
  let chartInstance;
  let tabelaDT;

  document.addEventListener('DOMContentLoaded', () => {
    const itens = listarItens('publicacoes');
    const selAutores = $('#filtroAutores');
    const selTipos = $('#filtroTipos');
    const selAnos = $('#filtroAnos');
    const selSiglas = $('#filtroSiglas');

    function popularFiltros() {
      const autores = [...new Set(itens.map(i => i.autor))].sort();
      const tipos = [...new Set(itens.map(i => i.tipo))].sort();
      const anos = [...new Set(itens.map(i => i.ano))].sort();
      const siglas = [...new Set(itens.map(i => i.sigla))].sort();
      autores.forEach(v => selAutores.append(new Option(v, v)));
      tipos.forEach(v => selTipos.append(new Option(v, v)));
      anos.forEach(v => selAnos.append(new Option(v, v)));
      siglas.forEach(v => selSiglas.append(new Option(v, v)));
    }

    function aplicarFiltros() {
      const q = $('#pesquisaInput').val().toLowerCase();
      const a = selAutores.val();
      const t = selTipos.val();
      const y = selAnos.val();
      const z = selSiglas.val();
      return itens.filter(i =>
        (!a || i.autor === a) &&
        (!t || i.tipo === t) &&
        (!y || i.ano === y) &&
        (!z || i.sigla === z) &&
        (!q || i.titulo.toLowerCase().includes(q))
      );
    }

    function renderizarTabela(data) {
      if (tabelaDT) tabelaDT.clear().rows.add(data).draw();
      else {
        tabelaDT = $('#tabelaPublicacoes').DataTable({
          data: data,
          columns: [
            { data: 'idpub' },
            { data: 'titulo' },
            { data: 'autor', render: d => `<strong>${d}</strong>` },
            { data: 'coautor' },
            { data: 'tipo' },
            { data: 'local' },
            { data: 'sigla' },
            { data: 'ano' },
            {
              data: null,
              render: d => `
                <div class="btn-group-custom">
                  <a href="${d.linkPublicacao}" class="btn btn-warning btn-sm" target="_blank">üåê Online</a>
                  ${
                    d.publicacaoArquivo
                      ? `<a href="${d.publicacaoArquivo}" target="_blank" class="btn btn-success btn-sm">üìñ PDF</a>`
                      : `<button class="btn btn-secondary btn-sm" disabled>‚ùå Sem PDF</button>`
                  }
                </div>`
            },
            {
              data: null,
              render: d => `
                <div class="btn-group-custom">
                <a href="${d.linkSite}" class="btn btn-danger btn-sm" target="_blank">üîó Submiss√£o</a>
                <button class="btn btn-primary btn-sm" onclick='mostrarReferencia(${JSON.stringify(d)})'>üìÑ Citar</button>
                </div>`
            }
          ],
          paging: true,
          responsive: true,
          language: {
            info: "Mostrando _START_ at√© _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 at√© 0 de 0 registros",
            lengthMenu: "Mostrar _MENU_ registros por p√°gina",
            search: "Pesquisar:",
            paginate: {
              first: "Primeiro", last: "√öltimo", next: "Pr√≥ximo", previous: "Anterior"
            }
          }
        });
      }
    }

    function renderizarGrafico(data) {
      const group = {};
      data.forEach(i => {
        if (!group[i.tipo]) group[i.tipo] = {};
        if (!group[i.tipo][i.ano]) group[i.tipo][i.ano] = 0;
        group[i.tipo][i.ano]++;
      });

      const tiposArr = Object.keys(group);
      const anosArr = [...new Set(data.map(i => i.ano))].sort();
      const colors = ['#007bff','#28a745','#ffc107','#dc3545','#17a2b8'];
      const datasets = tiposArr.map((tp, idx) => ({
        label: tp,
        backgroundColor: colors[idx % colors.length],
        data: anosArr.map(y => group[tp][y] || 0)
      }));

      const ctx = document.getElementById('graficoPublicacoes').getContext('2d');
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: anosArr, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          aspectRatio: 2,
          plugins: {
            legend: { position: 'bottom' },
            datalabels: { anchor:'end', align:'end', formatter: Math.round }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function atualizar() {
      const filtrado = aplicarFiltros();
      renderizarTabela(filtrado);
      renderizarGrafico(filtrado);
    }

    $('#pesquisaInput, #filtroAutores, #filtroTipos, #filtroAnos, #filtroSiglas').on('input change', atualizar);
    $('#btnLimpar').on('click', () => {
      $('#pesquisaInput').val('');
      selAutores.val('');
      selTipos.val('');
      selAnos.val('');
      selSiglas.val('');
      atualizar();
    });

    popularFiltros();
    atualizar();
  });

  function mostrarReferencia(item) {
    const ref = `
      <p><strong>T√≠tulo:</strong> ${item.titulo}</p>
      <p><strong>Autor Principal:</strong> ${item.autor}</p>
      <p><strong>Co-autor(es):</strong> ${item.coautor}</p>
      <p><strong>Tipo:</strong> ${item.tipo}</p>
      <p><strong>Ano:</strong> ${item.ano}</p>
      <p><strong>Local:</strong> ${item.local}</p>
      <p><strong>Sigla:</strong> ${item.sigla}</p>
      <p><strong>Link Submiss√£o:</strong> <a href="${item.linkSite}" target="_blank">${item.linkSite}</a></p>
      <p><strong>Link Publica√ß√£o:</strong> <a href="${item.linkPublicacao}" target="_blank">${item.linkPublicacao}</a></p>
      <p><strong style="color:red;">Como Referenciar (ABNT):</strong> ${item.referenciarPub}</p>`;
    document.getElementById('conteudoReferencia').innerHTML = ref;
    new bootstrap.Modal(document.getElementById('modalReferencia')).show();
  }

  function abrirJanela(id) {
    window.open(`modal.html?id=${id}`, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
  }
  </script>

  <meu-tradutor></meu-tradutor>
  <script src="javascript/components/tradutor.js" defer></script>
  <meu-footer></meu-footer>
</body>
</html>
